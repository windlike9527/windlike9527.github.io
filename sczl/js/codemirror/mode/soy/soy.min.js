// CodeMirror, copyright (c) by Marijn Haverbeke and others
// Distributed under an MIT license: https://codemirror.net/5/LICENSE
(function(f){"object"==typeof exports&&"object"==typeof module?f(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed")):"function"==typeof define&&define.amd?define(["../../lib/codemirror","../htmlmixed/htmlmixed"],f):f(CodeMirror)})(function(f){var h={noEndTag:!0,soyState:"param-def"},l={alias:{noEndTag:!0},delpackage:{noEndTag:!0},namespace:{noEndTag:!0,soyState:"namespace-def"},"@attribute":h,"@attribute?":h,"@param":h,"@param?":h,"@inject":h,"@inject?":h,"@state":h,template:{soyState:"templ-def",variableScope:!0},extern:{soyState:"param-def"},"export":{soyState:"export"},literal:{},msg:{},fallbackmsg:{noEndTag:!0,reduceIndent:!0},select:{},plural:{},let:{soyState:"var-def"},"if":{},javaimpl:{},jsimpl:{},elseif:{noEndTag:!0,reduceIndent:!0},"else":{noEndTag:!0,reduceIndent:!0},"switch":{},"case":{noEndTag:!0,reduceIndent:!0},"default":{noEndTag:!0,reduceIndent:!0},foreach:{variableScope:!0,soyState:"for-loop"},ifempty:{noEndTag:!0,reduceIndent:!0},"for":{variableScope:!0,soyState:"for-loop"},call:{soyState:"templ-ref"},param:{soyState:"param-ref"},print:{noEndTag:!0},deltemplate:{soyState:"templ-def",variableScope:!0},delcall:{soyState:"templ-ref"},log:{},element:{variableScope:!0},velog:{},"const":{soyState:"const-def"}},v=Object.keys(l).filter(function(e){return!l[e].noEndTag||l[e].reduceIndent});f.defineMode("soy",function(e){function k(b){return b[b.length-1]}function h(b,a,c){if(b.sol()){for(var d=0;d<a.indent&&b.eat(/\s/);d++);if(d)return null}d=b.string;if(c=c.exec(d.substr(b.pos)))b.string=d.substr(0,b.pos+c.index);c=b.hideFirstChars(a.indent,function(){var c=k(a.localStates);return c.mode.token(b,c.state)});b.string=d;return c}function n(b,a){return{element:a,next:b}}function r(b){b.context&&(b.context.scope&&(b.variables=b.context.scope),b.context=b.context.previousContext)}function u(b,a,c){a:{for(;b;){if(b.element===a){a=!0;break a}b=b.next}a=!1}return a?"variable-2":c?"variable":"variable-2 error"}function t(b,a,c){this.previousContext=b;this.tag=a;this.kind=null;this.scope=c}function p(b,a){var c;if(b.match(/[[]/))return a.soyState.push("list-literal"),a.context=new t(a.context,"list-literal",a.variables),a.lookupVariables=!1,null;if(b.match(/\bmap(?=\()/))return a.soyState.push("map-literal"),"keyword";if(b.match(/\brecord(?=\()/))return a.soyState.push("record-literal"),"keyword";if(b.match(/([\w]+)(?=\()/))return"variable callee";if(c=b.match(/^["']/))return a.soyState.push("string"),a.quoteKind=c[0],"string";if(b.match(/^[(]/))return a.soyState.push("open-parentheses"),null;if(b.match(/(null|true|false)(?!\w)/)||b.match(/0x([0-9a-fA-F]{2,})/)||b.match(/-?([0-9]*[.])?[0-9]+(e[0-9]*)?/))return"atom";if(b.match(/(\||[+\-*\/%]|[=!]=|\?:|[<>]=?)/))return"operator";if(c=b.match(/^\$([\w]+)/))return u(a.variables,c[1],!a.lookupVariables);if(c=b.match(/^\w+/))return/^(?:as|and|or|not|in|if)$/.test(c[0])?"keyword":null;b.next();return null}var m=f.getMode(e,"text/plain"),q={html:f.getMode(e,{name:"text/html",multilineTagIndentFactor:2,multilineTagIndentPastTag:!1,allowMissingTagName:!0}),attributes:m,text:m,uri:m,trusted_resource_uri:m,css:f.getMode(e,"text/css"),js:f.getMode(e,{name:"text/javascript",statementIndent:2*e.indentUnit})};return{startState:function(){return{soyState:[],variables:n(null,"ij"),scopes:null,indent:0,quoteKind:null,context:null,lookupVariables:!0,localStates:[{mode:q.html,state:f.startState(q.html)}]}},copyState:function(b){return{tag:b.tag,soyState:b.soyState.concat([]),variables:b.variables,context:b.context,indent:b.indent,quoteKind:b.quoteKind,lookupVariables:b.lookupVariables,localStates:b.localStates.map(function(a){return{mode:a.mode,state:f.copyState(a.mode,a.state)}})}},token:function(b,a){var c;switch(k(a.soyState)){case "comment":b.match(/^.*?\*\//)?a.soyState.pop():b.skipToEnd();if(!a.context||!a.context.scope)for(var d=/@param\??\s+(\S+)/g,g=b.current();c=d.exec(g);)a.variables=n(a.variables,c[1]);return"comment";case "string":return c=b.match(/^.*?(["']|\\[\s\S])/),c?c[1]==a.quoteKind&&(a.quoteKind=null,a.soyState.pop()):b.skipToEnd(),"string"}if(!a.soyState.length||"literal"!=k(a.soyState)){if(b.match(/^\/\*/))return a.soyState.push("comment"),"comment";if(b.match(b.sol()?/^\s*\/\/.*/:/^\s+\/\/.*/))return"comment"}switch(k(a.soyState)){case "templ-def":if(b.match(/^\.?([\w]+(?!\.[\w]+)*)/))return a.soyState.pop(),"def";b.next();return null;case "templ-ref":if(c=b.match(/(\.?[a-zA-Z_][a-zA-Z_0-9]+)+/))return a.soyState.pop(),"."==c[0][0]?"variable-2":"variable";if(c=b.match(/^\$([\w]+)/))return a.soyState.pop(),u(a.variables,c[1],!a.lookupVariables);b.next();return null;case "namespace-def":if(b.match(/^\.?([\w\.]+)/))return a.soyState.pop(),"variable";b.next();return null;case "param-def":if(b.match(/^\*/))return a.soyState.pop(),a.soyState.push("param-type"),"type";if(c=b.match(/^\w+/))return a.variables=n(a.variables,c[0]),a.soyState.pop(),a.soyState.push("param-type"),"def";b.next();return null;case "param-ref":if(b.match(/^\w+/))return a.soyState.pop(),"property";b.next();return null;case "open-parentheses":return b.match(/[)]/)?(a.soyState.pop(),null):p(b,a);case "param-type":d=b.peek();if(-1!="}]\x3d\x3e,".indexOf(d))return a.soyState.pop(),null;if("["==d)return a.soyState.push("param-type-record"),null;if("("==d)return a.soyState.push("param-type-template"),null;if("\x3c"==d)return a.soyState.push("param-type-parameter"),null;if(b.match(/^([\w]+|[?])/))return"type";b.next();return null;case "param-type-record":d=b.peek();if("]"==d)return a.soyState.pop(),null;if(b.match(/^\w+/))return a.soyState.push("param-type"),"property";b.next();return null;case "param-type-parameter":if(b.match(/^[>]/))return a.soyState.pop(),null;if(b.match(/^[<,]/))return a.soyState.push("param-type"),null;b.next();return null;case "param-type-template":if(b.match(/[>]/))return a.soyState.pop(),a.soyState.push("param-type"),null;if(b.match(/^\w+/))return a.soyState.push("param-type"),"def";b.next();return null;case "var-def":if(c=b.match(/^\$([\w]+)/))return a.variables=n(a.variables,c[1]),a.soyState.pop(),"def";b.next();return null;case "for-loop":if(b.match(/\bin\b/))return a.soyState.pop(),"keyword";if("$"==b.peek())return a.soyState.push("var-def"),null;b.next();return null;case "record-literal":if(b.match(/^[)]/))return a.soyState.pop(),null;if(b.match(/[(,]/))return a.soyState.push("map-value"),a.soyState.push("record-key"),null;b.next();return null;case "map-literal":if(b.match(/^[)]/))return a.soyState.pop(),null;if(b.match(/[(,]/))return a.soyState.push("map-value"),a.soyState.push("map-value"),null;b.next();return null;case "list-literal":return b.match("]")?(a.soyState.pop(),a.lookupVariables=!0,r(a),null):b.match(/\bfor\b/)?(a.lookupVariables=!0,a.soyState.push("for-loop"),"keyword"):p(b,a);case "record-key":if(b.match(/[\w]+/))return"property";if(b.match(/^[:]/))return a.soyState.pop(),null;b.next();return null;case "map-value":return")"==b.peek()||","==b.peek()||b.match(/^[:)]/)?(a.soyState.pop(),null):p(b,a);case "import":if(b.eat(";"))return a.soyState.pop(),a.indent-=2*e.indentUnit,null;if(b.match(/\w+(?=\s+as\b)/))return"variable";if(c=b.match(/\w+/))return/\b(from|as)\b/.test(c[0])?"keyword":"def";if(c=b.match(/^["']/))return a.soyState.push("string"),a.quoteKind=c[0],"string";b.next();return null;case "tag":return void 0===a.tag?(d=!0,g=""):g=(d="/"==a.tag[0])?a.tag.substring(1):a.tag,b.match(/^\/?}/)?((g="/}"==b.current())&&!d&&r(a),"/template"==a.tag||"/deltemplate"==a.tag?(a.variables=n(null,"ij"),a.indent=0):a.indent-=e.indentUnit*(g||-1==v.indexOf(a.tag)?2:1),a.soyState.pop(),"keyword"):b.match(/^([\w?]+)(?==)/)?(a.context&&a.context.tag==g&&"kind"==b.current()&&(c=b.match(/^="([^"]+)/,!1))&&(d=c[1],a.context.kind=d,g=q[d]||q.html,d=k(a.localStates),d.mode.indent&&(a.indent+=d.mode.indent(d.state,"","")),a.localStates.push({mode:g,state:f.startState(g)})),"attribute"):p(b,a);case "template-call-expression":return b.match(/^([\w-?]+)(?==)/)?"attribute":b.eat("\x3e")||b.eat("/\x3e")?(a.soyState.pop(),"keyword"):p(b,a);case "literal":return b.match("{/literal}",!1)?(a.soyState.pop(),this.token(b,a)):h(b,a,/\{\/literal}/);case "export":if(c=b.match(/\w+/)){a.soyState.pop();if("const"==c)return a.soyState.push("const-def"),"keyword";if("extern"==c)return a.soyState.push("param-def"),"keyword"}else b.next();return null;case "const-def":if(b.match(/^\w+/))return a.soyState.pop(),"def";b.next();return null}if(b.match("{literal}"))return a.indent+=e.indentUnit,a.soyState.push("literal"),a.context=new t(a.context,"literal",a.variables),"keyword";if(c=b.match(/^\{([/@\\]?\w+\??)(?=$|[\s}]|\/[/*])/)){var m=a.tag;a.tag=c[1];var d="/"==a.tag[0],w=!!l[a.tag],g=d?a.tag.substring(1):a.tag;b=l[g];"/switch"!=a.tag&&(a.indent+=((d||b&&b.reduceIndent)&&"switch"!=m?1:2)*e.indentUnit);a.soyState.push("tag");c=!1;b?(d||b.soyState&&a.soyState.push(b.soyState),b.noEndTag||!w&&d)?d&&(d="extern"==g&&a.context&&"export"==a.context.tag,!a.context||a.context.tag!=g&&!d?c=!0:a.context&&(a.context.kind&&(a.localStates.pop(),d=k(a.localStates),d.mode.indent&&(a.indent-=d.mode.indent(d.state,"",""))),r(a))):a.context=new t(a.context,a.tag,b.variableScope?a.variables:null):d&&(c=!0);return(c?"error ":"")+"keyword"}return b.eat("{")?(a.tag="print",a.indent+=2*e.indentUnit,a.soyState.push("tag"),"keyword"):!a.context&&b.sol()&&b.match(/import\b/)?(a.soyState.push("import"),a.indent+=2*e.indentUnit,"keyword"):b.match("\x3c{")?(a.soyState.push("template-call-expression"),a.indent+=2*e.indentUnit,a.soyState.push("tag"),"keyword"):b.match("\x3c/\x3e")?(a.indent-=1*e.indentUnit,"keyword"):h(b,a,/\{|\s+\/\/|\/\*/)},indent:function(b,a,c){var d=b.indent,g=k(b.soyState);if("comment"==g)return f.Pass;if("literal"==g)/^\{\/literal}/.test(a)&&(d-=e.indentUnit);else{if(/^\s*\{\/(template|deltemplate)\b/.test(a))return 0;/^\{(\/|(fallbackmsg|elseif|else|ifempty)\b)/.test(a)&&(d-=e.indentUnit);"switch"!=b.tag&&/^\{(case|default)\b/.test(a)&&(d-=e.indentUnit);/^\{\/switch\b/.test(a)&&(d-=e.indentUnit)}b=k(b.localStates);d&&b.mode.indent&&(d+=b.mode.indent(b.state,a,c));return d},innerMode:function(b){return b.soyState.length&&"literal"!=k(b.soyState)?null:k(b.localStates)},electricInput:/^\s*\{(\/|\/template|\/deltemplate|\/switch|fallbackmsg|elseif|else|case|default|ifempty|\/literal\})$/,lineComment:"//",blockCommentStart:"/*",blockCommentEnd:"*/",blockCommentContinue:" * ",useInnerComments:!1,fold:"indent"}},"htmlmixed");f.registerHelper("wordChars","soy",/[\w$]/);f.registerHelper("hintWords","soy",Object.keys(l).concat(["css","debugger"]));f.defineMIME("text/x-soy","soy")});